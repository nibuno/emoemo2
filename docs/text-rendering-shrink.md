# テキスト描画の大サイズ化（shrink方式への変更）

変更日: 2025-02-08

## 背景

### 課題
- 生成される絵文字のフォントサイズが小さいというフィードバックがあった
- 他の絵文字ジェネレーターと比較して、文字がキャンバスを十分に使い切れていなかった

### 原因
以前の方式はフォントメトリクス（ascender/descender等の余白を含む）を基準にサイズを決定していた。フォントメトリクスには実際のグリフ（描画される文字）の外側にも余白が含まれるため、見た目上の文字サイズがキャンバスに対して小さくなっていた。

## Before / After

### Before: フォントメトリクス基準の方式
1. `fontSize = 200` から1pxずつデクリメント
2. `fontSize * lineHeightRatio(1.15) * 行数 <= canvasHeight * 0.95` になるまで縮小
3. 横幅が溢れたら `scaleX` で水平圧縮

**問題**: フォントメトリクスの余白分だけ文字が小さくなる

### After: 実ピクセル基準のトリミング方式（行ごと）
1. 各行を個別にオフスクリーンキャンバスに大きなフォント（`canvasWidth * 1.5` px）で描画
2. `getImageData` で各行の実ピクセル境界を検出し、透明部分をトリミング
3. トリミング済みの行を実ピクセルベースの行間（文字高さの5%）で結合
4. 高さ優先スケーリングでキャンバスにフィット（縦はフルに使い、横のみ圧縮）

**効果**: フォントメトリクスの余白が除去され、文字がキャンバスを最大限使い切る

## 意思決定の経緯

### なぜ実ピクセル基準のトリミングを採用したか

**検討した案**:
| 案 | 説明 | 評価 |
|---|------|------|
| A. パラメータ調整 | `maxHeight`比率を上げる、`lineHeightRatio`を下げる | 簡易だがフォントごとの差異を吸収できない |
| B. 実ピクセルトリミング | 大きく描画→透明部分を切り取り→リスケール | フォント種別に依存せず正確 |

**決定**: 方式B

**理由**: フォントによってメトリクスの余白量が異なるため、パラメータ調整では全フォントに対して最適化できない。実ピクセルベースなら、どのフォントでも見た目の文字サイズが最大化される。

### 行ごとトリミング + 高さ優先スケーリングの追加導入

初回実装後に2つの問題が見つかり、追加で対応した。

**問題1: 複数行テキストの行間余白**
- 全行まとめてトリミングする方式では、フォントメトリクス由来の行間余白が残っていた
- 行ごとに個別トリミング → 結合する方式に変更し、行間を実ピクセルベース（文字高さの5%）で制御

**問題2: 英語など横長テキストでの上下余白**
- `Math.min(横倍率, 縦倍率)` でアスペクト比を維持してフィットさせると、横長テキストで縦に余白が生じていた
- 高さ優先スケーリング（縦はフルに使い、横のみ圧縮）に変更して解消

## 変更されたファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/utils/textRenderer.ts` | 新規作成。トリミング方式の描画ロジックを実装 |
| `src/components/Preview.tsx` | 表示・ダウンロードの描画ロジックを `renderTextToCanvas` に置き換え |
| `src/components/PreviewThumbnail.tsx` | サムネイル描画ロジックを `renderTextToCanvas` に置き換え |

## 副次的な改善
- 3箇所に重複していた描画ロジックが `textRenderer.ts` に集約された
